name: "CI"

on:
  pull_request:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore SpecLens.sln

      - name: Build
        run: dotnet build SpecLens.sln -c Release --no-restore

      - name: Unit Tests
        run: |
          New-Item -ItemType Directory -Force "$env:GITHUB_WORKSPACE\\TestResults\\coverage" | Out-Null
          dotnet test JdeClient.Core.UnitTests/JdeClient.Core.UnitTests.csproj -c Release --no-build --results-directory "$env:GITHUB_WORKSPACE\\TestResults" -- --coverage --coverage-output "$env:GITHUB_WORKSPACE\\TestResults\\coverage\\coverage.cobertura.xml" --coverage-output-format cobertura

      - name: Install ReportGenerator
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Generate Coverage Report
        run: reportgenerator -reports:"TestResults/coverage/coverage.cobertura.xml" -targetdir:"TestResults/coverage-report" -reporttypes:"HtmlInline;Cobertura;TextSummary;MarkdownSummary"

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: TestResults/coverage/coverage.cobertura.xml
          fail_ci_if_error: false
          verbose: true

      - name: Publish Coverage Summary
        run: Get-Content TestResults/coverage-report/Summary.md | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: TestResults/coverage-report
